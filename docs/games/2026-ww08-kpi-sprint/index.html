<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI Sprint</title>
  <style>
    :root{--bg:#0b0f19;--panel:#0f172a;--text:#e5e7eb;--muted:#9ca3af;--brand:#22d3ee;--brand2:#7c3aed;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:920px;margin:0 auto;padding:20px;}
    .card{background:rgba(15,23,42,.82);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    a{color:var(--brand)}
    h1{font-size:18px;margin:0}
    .meta{color:var(--muted);font-size:13px}
    canvas{width:100%;max-width:720px;height:auto;border-radius:12px;background:#050814;display:block;margin:12px auto;touch-action:manipulation;}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    button{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:700}
    button:focus{outline:2px solid rgba(34,211,238,.35);outline-offset:2px}
    .hint{color:var(--muted);font-size:14px;line-height:1.5}
    @media (prefers-reduced-motion: reduce){*{scroll-behavior:auto;animation:none;transition:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>KPI Sprint</h1>
          <div class="meta">조작: <b>Space</b> / <b>Tap</b> · <span id="status">Ready</span></div>
        </div>
        <div class="meta"><a href="../../index.html">← 블로그 홈</a> · <a href="../index.html">게임 목록</a></div>
      </div>

      <p class="hint" id="desc">30초 동안 버튼을 눌러 <b>병목(Bottleneck)</b>을 제거하고, 가능한 많은 <b>KPI 포인트</b>를 얻으세요. 조작: <b>Space</b> 또는 <b>Tap</b>.</p>

      <canvas id="c" width="720" height="480" aria-label="게임 캔버스"></canvas>

      <div class="row">
        <button id="btnStart">Start</button>
        <button id="btnRestart">Restart</button>
        <button id="btnMute" aria-pressed="false">Mute</button>
      </div>

      <p class="hint">접근성/정책: 자동 사운드 재생 없음(유저 인터랙션 이후), 키보드로 시작/재시작 가능.</p>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');
  const btnStart = document.getElementById('btnStart');
  const btnRestart = document.getElementById('btnRestart');
  const btnMute = document.getElementById('btnMute');

  let running = false;
  let muted = false;

  // Game state
  let tLeft = 30.0;
  let score = 0;
  let bottleneck = 1.0; // 1.0 = bad (full), 0.0 = cleared
  let best = Number(localStorage.getItem('kpi_sprint_best') || 0);

  function setStatus(s){ statusEl.textContent = s; }

  function reset(){
    running = false;
    tLeft = 30.0;
    score = 0;
    bottleneck = 1.0;
    lastTs = 0;
    setStatus('Ready');
    draw();
  }

  function start(){
    if (running) return;
    running = true;
    setStatus('Running');
    requestAnimationFrame(loop);
  }

  function toggleMute(){
    muted = !muted;
    btnMute.setAttribute('aria-pressed', String(muted));
    btnMute.textContent = muted ? 'Unmute' : 'Mute';
  }

  let lastTapAt = 0;
  function action(){
    const now = performance.now();
    if (!running && tLeft <= 0){
      reset();
      start();
      return;
    }
    if (!running) start();

    // debounce (touch jitter)
    if (now - lastTapAt < 60) return;
    lastTapAt = now;

    // chip away bottleneck; when cleared => score and refill harder
    bottleneck = Math.max(0, bottleneck - 0.18);
    if (bottleneck <= 0){
      score += Math.max(1, Math.ceil(10 * (tLeft/30)));
      bottleneck = 0.65 + Math.random()*0.35;
    }
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // background
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // HUD
    const pad = 18;
    const x = pad, y = 88, w = canvas.width - pad*2, h = canvas.height - 120;

    ctx.fillStyle = '#e5e7eb';
    ctx.font = '800 22px system-ui';
    ctx.fillText('KPI Sprint', 22, 40);

    ctx.fillStyle = '#9ca3af';
    ctx.font = '14px system-ui';
    ctx.fillText('30초 동안 병목을 깎아서 KPI 포인트를 얻기', 22, 64);

    ctx.fillStyle = '#e5e7eb';
    ctx.font = '700 16px system-ui';
    ctx.fillText('TIME', x, y-14);
    ctx.fillText(String(Math.max(0, Math.ceil(tLeft))), x+76, y-14);
    ctx.fillText('SCORE', x+160, y-14);
    ctx.fillText(String(score), x+240, y-14);

    ctx.fillStyle = '#9ca3af';
    ctx.fillText('BEST', x+320, y-14);
    ctx.fillText(String(best), x+372, y-14);

    // arena
    ctx.fillStyle = 'rgba(0,0,0,.20)';
    ctx.fillRect(x, y, w, h);

    // bottleneck meter
    const meterW = Math.min(520, w-40);
    const mx = x + (w-meterW)/2;
    const my = y + h/2 - 18;
    const mh = 36;

    ctx.fillStyle = 'rgba(255,255,255,.08)';
    ctx.fillRect(mx, my, meterW, mh);

    const fill = Math.max(0, Math.min(1, bottleneck));
    const good = 1 - fill;
    const r = Math.floor(124 + 50*good);
    const g = Math.floor(58 + 155*good);
    const b = Math.floor(237 - 40*good);
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(mx, my, meterW*fill, mh);

    ctx.strokeStyle = 'rgba(34,211,238,.35)';
    ctx.strokeRect(mx, my, meterW, mh);

    ctx.fillStyle = '#e5e7eb';
    ctx.font = '700 14px system-ui';
    ctx.fillText('BOTTLENECK', mx, my-8);

    ctx.fillStyle = '#9ca3af';
    ctx.font = '14px system-ui';
    if (!running && tLeft > 0){
      ctx.fillText('Space 또는 Tap으로 시작', mx, my+mh+28);
    } else if (tLeft > 0){
      ctx.fillText('계속 눌러서 병목을 0으로 만들면 점수 획득!', mx, my+mh+28);
    }

    // end overlay
    if (!running && tLeft <= 0){
      ctx.fillStyle = 'rgba(0,0,0,.55)';
      ctx.fillRect(x, y, w, h);
      ctx.fillStyle = '#e5e7eb';
      ctx.font = '900 28px system-ui';
      ctx.fillText('DONE', x+22, y+50);
      ctx.font = '700 18px system-ui';
      ctx.fillText(`Score: ${score}  (Best: ${best})`, x+22, y+82);
      ctx.fillStyle = '#9ca3af';
      ctx.font = '14px system-ui';
      ctx.fillText('Restart 버튼 또는 Space로 다시 시작', x+22, y+110);
    }
  }

  let lastTs = 0;
  function loop(ts){
    if (!running) return;
    const dt = Math.min(0.05, (ts - lastTs) / 1000 || 0);
    lastTs = ts;

    tLeft -= dt;
    // bottleneck slowly comes back (always pressure)
    bottleneck = Math.min(1.0, bottleneck + dt * 0.06);

    if (tLeft <= 0){
      tLeft = 0;
      running = false;
      setStatus('Done');
      if (score > best){
        best = score;
        try{ localStorage.setItem('kpi_sprint_best', String(best)); }catch(_e){}
      }
      draw();
      return;
    }

    draw();
    requestAnimationFrame(loop);
  }

  // Events
  btnStart.addEventListener('click', start);
  btnRestart.addEventListener('click', () => { reset(); start(); });
  btnMute.addEventListener('click', toggleMute);

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space' || e.code === 'Enter'){
      e.preventDefault();
      action();
    }
  });

  canvas.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    action();
  });

  reset();
})();
</script>
</body>
</html>
